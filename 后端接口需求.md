# 机器学习可视化界面 - 后端接口需求

## 📋 概述

前端UI已基本完成，包括组件拖拽、连接、属性配置、项目管理等功能。现在需要实现后端接口来支持实际的机器学习流程执行。

## 🏗️ 架构设计

### 前后端分离架构
```
前端 (PyQt5 UI)  ←→  后端接口层  ←→  ML执行引擎  ←→  ML库 (sklearn, tensorflow等)
     ↓                    ↓              ↓              ↓
  用户交互           API接口         算法实现        具体计算
  界面展示           数据转换         流程控制        模型训练
  参数配置           错误处理         结果收集        数据处理
```

### 数据流设计
```
1. 前端收集工作流程配置 → JSON格式
2. 后端解析配置 → 组件执行图
3. 按拓扑顺序执行组件 → 数据在组件间流转
4. 收集执行结果 → 返回前端展示
```

## 🔌 核心接口需求

### 1. 工作流程执行接口

#### 1.1 执行工作流程
```python
def execute_workflow(workflow_data: dict) -> dict:
    """
    执行完整的机器学习工作流程
    
    Args:
        workflow_data: {
            "components": [
                {
                    "id": "comp_1",
                    "type": "data",
                    "name": "数据加载", 
                    "properties": {"file_path": "data.csv", ...}
                },
                ...
            ],
            "connections": [
                {
                    "start_component": "comp_1",
                    "start_port": 0,
                    "end_component": "comp_2", 
                    "end_port": 0
                },
                ...
            ]
        }
        
    Returns:
        {
            "success": True/False,
            "message": "执行结果描述",
            "execution_id": "唯一执行ID",
            "results": {
                "comp_1": {"output_data": ..., "metrics": ...},
                "comp_2": {"output_data": ..., "metrics": ...}
            },
            "execution_time": 123.45,
            "error_details": "错误详情(如果有)"
        }
    """
```

#### 1.2 获取执行状态
```python
def get_execution_status(execution_id: str) -> dict:
    """
    获取工作流程执行状态
    
    Returns:
        {
            "status": "running/completed/failed",
            "progress": 0.75,  # 0-1之间
            "current_step": "正在执行的组件名称",
            "completed_steps": ["已完成的组件列表"],
            "estimated_time_remaining": 30.5
        }
    """
```

#### 1.3 停止执行
```python
def stop_execution(execution_id: str) -> dict:
    """
    停止工作流程执行
    
    Returns:
        {
            "success": True/False,
            "message": "停止结果描述"
        }
    """
```

### 2. 组件执行接口

#### 2.1 数据处理组件

##### 数据加载
```python
def execute_data_loader(config: dict) -> dict:
    """
    执行数据加载组件
    
    Args:
        config: {
            "file_path": "data.csv",
            "separator": ",",
            "encoding": "utf-8",
            "header": True,
            "index_col": None
        }
        
    Returns:
        {
            "success": True/False,
            "data": pandas.DataFrame,  # 加载的数据
            "shape": [1000, 10],       # 数据形状
            "columns": ["col1", "col2", ...],
            "dtypes": {"col1": "int64", ...},
            "memory_usage": "2.5 MB",
            "preview": "前5行数据的HTML表格",
            "message": "加载了1000行10列数据"
        }
    """
```

##### 数据清洗
```python
def execute_data_cleaner(config: dict, input_data: any) -> dict:
    """
    执行数据清洗组件
    
    Args:
        config: {
            "remove_duplicates": True,
            "handle_missing": "drop/fill_mean/fill_median/fill_mode",
            "remove_outliers": True,
            "outlier_method": "iqr/zscore",
            "outlier_threshold": 3.0
        }
        input_data: 输入的DataFrame
        
    Returns:
        {
            "success": True/False,
            "data": pandas.DataFrame,  # 清洗后的数据
            "cleaning_report": {
                "duplicates_removed": 50,
                "missing_values_handled": 100,
                "outliers_removed": 25,
                "original_shape": [1000, 10],
                "final_shape": [925, 10]
            },
            "message": "数据清洗完成"
        }
    """
```

##### 特征选择
```python
def execute_feature_selector(config: dict, input_data: any) -> dict:
    """
    执行特征选择组件
    
    Args:
        config: {
            "method": "variance/chi2/mutual_info/rfe",
            "n_features": 10,
            "threshold": 0.1,
            "target_column": "target"
        }
        
    Returns:
        {
            "success": True/False,
            "data": pandas.DataFrame,  # 选择特征后的数据
            "selected_features": ["feature1", "feature2", ...],
            "feature_scores": {"feature1": 0.85, ...},
            "selection_report": "特征选择报告",
            "message": "选择了10个最重要的特征"
        }
    """
```

##### 数据分割
```python
def execute_data_splitter(config: dict, input_data: any) -> dict:
    """
    执行数据分割组件
    
    Args:
        config: {
            "test_size": 0.2,
            "random_state": 42,
            "stratify": True,
            "target_column": "target"
        }
        
    Returns:
        {
            "success": True/False,
            "train_data": pandas.DataFrame,
            "test_data": pandas.DataFrame,
            "train_target": pandas.Series,
            "test_target": pandas.Series,
            "split_info": {
                "train_size": 800,
                "test_size": 200,
                "train_ratio": 0.8,
                "test_ratio": 0.2
            },
            "message": "数据分割完成"
        }
    """
```

#### 2.2 预处理组件

##### 标准化
```python
def execute_scaler(config: dict, input_data: any) -> dict:
    """
    执行标准化组件
    
    Args:
        config: {
            "method": "standard/minmax/robust/normalizer",
            "feature_range": [0, 1],  # for MinMaxScaler
            "with_mean": True,        # for StandardScaler
            "with_std": True          # for StandardScaler
        }
        
    Returns:
        {
            "success": True/False,
            "data": pandas.DataFrame,  # 标准化后的数据
            "scaler_params": {
                "mean_": [1.2, 3.4, ...],
                "scale_": [0.8, 1.2, ...],
                "feature_range": [0, 1]
            },
            "scaler_object": "序列化的scaler对象",
            "message": "数据标准化完成"
        }
    """
```

##### 编码
```python
def execute_encoder(config: dict, input_data: any) -> dict:
    """
    执行编码组件
    
    Args:
        config: {
            "method": "onehot/label/target/ordinal",
            "columns": ["category1", "category2"],
            "handle_unknown": "error/ignore",
            "drop": "first"  # for OneHotEncoder
        }
        
    Returns:
        {
            "success": True/False,
            "data": pandas.DataFrame,  # 编码后的数据
            "encoding_info": {
                "original_columns": ["cat1", "cat2"],
                "encoded_columns": ["cat1_A", "cat1_B", "cat2_X", "cat2_Y"],
                "categories": {"cat1": ["A", "B"], "cat2": ["X", "Y"]}
            },
            "encoder_object": "序列化的encoder对象",
            "message": "分类变量编码完成"
        }
    """
```

#### 2.3 模型组件

##### 随机森林
```python
def execute_random_forest(config: dict, input_data: any) -> dict:
    """
    执行随机森林组件
    
    Args:
        config: {
            "n_estimators": 100,
            "max_depth": 10,
            "min_samples_split": 2,
            "min_samples_leaf": 1,
            "random_state": 42,
            "task_type": "classification/regression"
        }
        input_data: {"X_train": df, "y_train": series, "X_test": df, "y_test": series}
        
    Returns:
        {
            "success": True/False,
            "model": "序列化的模型对象",
            "predictions": {
                "train_pred": [1, 0, 1, ...],
                "test_pred": [0, 1, 0, ...],
                "train_proba": [[0.2, 0.8], ...],  # 分类任务
                "test_proba": [[0.3, 0.7], ...]
            },
            "training_info": {
                "training_time": 5.2,
                "n_features": 10,
                "feature_importances": {"feature1": 0.15, ...}
            },
            "message": "随机森林模型训练完成"
        }
    """
```

##### 线性回归
```python
def execute_linear_regression(config: dict, input_data: any) -> dict:
    """
    执行线性回归组件
    
    Args:
        config: {
            "fit_intercept": True,
            "normalize": False,
            "regularization": "none/l1/l2/elastic",
            "alpha": 1.0,
            "l1_ratio": 0.5  # for elastic net
        }
        
    Returns:
        {
            "success": True/False,
            "model": "序列化的模型对象",
            "predictions": {
                "train_pred": [1.2, 3.4, ...],
                "test_pred": [2.1, 4.3, ...]
            },
            "model_info": {
                "coefficients": [0.5, -0.3, ...],
                "intercept": 1.2,
                "r2_score": 0.85
            },
            "message": "线性回归模型训练完成"
        }
    """
```

#### 2.4 评估组件

##### 分类评估
```python
def execute_classification_evaluator(config: dict, input_data: any) -> dict:
    """
    执行分类评估组件
    
    Args:
        config: {
            "metrics": ["accuracy", "precision", "recall", "f1", "auc"],
            "average": "macro/micro/weighted",
            "pos_label": 1
        }
        input_data: {"y_true": series, "y_pred": series, "y_proba": array}
        
    Returns:
        {
            "success": True/False,
            "metrics": {
                "accuracy": 0.85,
                "precision": 0.82,
                "recall": 0.88,
                "f1_score": 0.85,
                "auc_score": 0.90
            },
            "confusion_matrix": [[50, 5], [8, 37]],
            "classification_report": "详细分类报告",
            "roc_curve": {
                "fpr": [0, 0.1, 0.2, ...],
                "tpr": [0, 0.8, 0.9, ...],
                "thresholds": [1, 0.9, 0.8, ...]
            },
            "message": "分类评估完成"
        }
    """
```

##### 回归评估
```python
def execute_regression_evaluator(config: dict, input_data: any) -> dict:
    """
    执行回归评估组件
    
    Args:
        config: {
            "metrics": ["mse", "rmse", "mae", "r2", "mape"]
        }
        input_data: {"y_true": series, "y_pred": series}
        
    Returns:
        {
            "success": True/False,
            "metrics": {
                "mse": 0.25,
                "rmse": 0.5,
                "mae": 0.4,
                "r2_score": 0.85,
                "mape": 0.15
            },
            "residuals": [0.1, -0.2, 0.05, ...],
            "prediction_vs_actual": {
                "actual": [1.0, 2.0, 3.0, ...],
                "predicted": [1.1, 1.8, 3.2, ...]
            },
            "message": "回归评估完成"
        }
    """
```

### 3. 数据管理接口

#### 3.1 数据预览
```python
def get_data_preview(data_id: str, rows: int = 10) -> dict:
    """
    获取数据预览
    
    Returns:
        {
            "success": True/False,
            "preview_html": "HTML格式的数据表格",
            "shape": [1000, 10],
            "columns": ["col1", "col2", ...],
            "dtypes": {"col1": "int64", ...},
            "missing_values": {"col1": 5, "col2": 0},
            "memory_usage": "2.5 MB"
        }
    """
```

#### 3.2 数据统计
```python
def get_data_statistics(data_id: str) -> dict:
    """
    获取数据统计信息
    
    Returns:
        {
            "success": True/False,
            "numeric_stats": {
                "col1": {"mean": 1.5, "std": 0.8, "min": 0, "max": 5},
                ...
            },
            "categorical_stats": {
                "cat_col": {"unique": 3, "top": "A", "freq": 500},
                ...
            },
            "correlation_matrix": [[1.0, 0.5], [0.5, 1.0]],
            "distribution_plots": "base64编码的图片数据"
        }
    """
```

### 4. 可视化接口

#### 4.1 生成图表
```python
def generate_plot(plot_type: str, data: dict, config: dict) -> dict:
    """
    生成可视化图表
    
    Args:
        plot_type: "scatter/line/bar/histogram/heatmap/roc_curve/confusion_matrix"
        data: 绘图数据
        config: 绘图配置
        
    Returns:
        {
            "success": True/False,
            "plot_base64": "base64编码的图片",
            "plot_html": "交互式图表的HTML",
            "plot_config": "图表配置信息"
        }
    """
```

### 5. 模型管理接口

#### 5.1 保存模型
```python
def save_model(model_data: dict, model_name: str) -> dict:
    """
    保存训练好的模型
    
    Returns:
        {
            "success": True/False,
            "model_id": "唯一模型ID",
            "model_path": "模型保存路径",
            "model_info": "模型信息"
        }
    """
```

#### 5.2 加载模型
```python
def load_model(model_id: str) -> dict:
    """
    加载已保存的模型
    
    Returns:
        {
            "success": True/False,
            "model": "反序列化的模型对象",
            "model_info": "模型信息"
        }
    """
```

## 🔄 异步执行支持

### 任务队列接口
```python
def submit_async_task(task_type: str, task_data: dict) -> dict:
    """
    提交异步任务
    
    Returns:
        {
            "success": True/False,
            "task_id": "任务ID",
            "estimated_time": 120.5
        }
    """

def get_task_status(task_id: str) -> dict:
    """
    获取任务状态
    
    Returns:
        {
            "status": "pending/running/completed/failed",
            "progress": 0.75,
            "result": "任务结果(如果完成)",
            "error": "错误信息(如果失败)"
        }
    """
```

## 📊 错误处理规范

### 统一错误格式
```python
{
    "success": False,
    "error_code": "DATA_LOAD_ERROR",
    "error_message": "用户友好的错误描述",
    "error_details": "详细的技术错误信息",
    "suggestions": ["建议的解决方案1", "建议的解决方案2"]
}
```

### 常见错误代码
- `DATA_LOAD_ERROR`: 数据加载失败
- `INVALID_PARAMETERS`: 参数无效
- `MODEL_TRAINING_ERROR`: 模型训练失败
- `INSUFFICIENT_DATA`: 数据不足
- `MEMORY_ERROR`: 内存不足
- `TIMEOUT_ERROR`: 执行超时

## 🚀 实现优先级

### 高优先级 (核心功能)
1. 数据加载组件
2. 基础预处理组件 (标准化、编码)
3. 简单模型组件 (线性回归、随机森林)
4. 基础评估组件
5. 工作流程执行引擎

### 中优先级 (增强功能)
1. 高级预处理组件
2. 更多模型算法
3. 详细的可视化功能
4. 模型保存/加载
5. 异步执行支持

### 低优先级 (扩展功能)
1. 高级评估指标
2. 自动化特征工程
3. 超参数优化
4. 模型解释性分析
5. 分布式计算支持

## 📝 接口实现建议

1. **使用标准库**: 优先使用scikit-learn、pandas、numpy等成熟库
2. **数据序列化**: 使用pickle或joblib保存模型和数据
3. **内存管理**: 大数据集使用分块处理或数据流
4. **错误处理**: 完善的异常捕获和用户友好的错误信息
5. **日志记录**: 详细的执行日志便于调试
6. **性能监控**: 记录执行时间和资源使用情况

这份接口需求文档提供了完整的后端实现指导，你可以根据优先级逐步实现这些接口。
