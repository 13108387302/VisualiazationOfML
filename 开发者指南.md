# æœºå™¨å­¦ä¹ å¯è§†åŒ–ç•Œé¢ - å¼€å‘è€…æŒ‡å—

## ðŸ“‹ ç›®å½•
1. [é¡¹ç›®æž¶æž„æ¦‚è¿°](#é¡¹ç›®æž¶æž„æ¦‚è¿°)
2. [æ ¸å¿ƒæ¨¡å—è¯¦è§£](#æ ¸å¿ƒæ¨¡å—è¯¦è§£)
3. [æ•°æ®æµå’Œäº‹ä»¶æœºåˆ¶](#æ•°æ®æµå’Œäº‹ä»¶æœºåˆ¶)
4. [æ‰©å±•å¼€å‘æŒ‡å—](#æ‰©å±•å¼€å‘æŒ‡å—)
5. [åŽç«¯é›†æˆæŒ‡å—](#åŽç«¯é›†æˆæŒ‡å—)
6. [è°ƒè¯•å’Œæµ‹è¯•](#è°ƒè¯•å’Œæµ‹è¯•)
7. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
8. [å¸¸è§é—®é¢˜è§£ç­”](#å¸¸è§é—®é¢˜è§£ç­”)

## ðŸ—ï¸ é¡¹ç›®æž¶æž„æ¦‚è¿°

### æ•´ä½“æž¶æž„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MLVisualizationUI                    â”‚
â”‚                      (ä¸»çª—å£)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ComponentLib â”‚      MLCanvas       â”‚   PropertyPanel     â”‚
â”‚  (ç»„ä»¶åº“)   â”‚      (ç”»å¸ƒ)         â”‚   (å±žæ€§é¢æ¿)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚           â”‚           â”‚
        MLComponent ConnectionPort ConnectionLine
        (MLç»„ä»¶)    (è¿žæŽ¥ç«¯å£)    (è¿žæŽ¥çº¿)
```

### è®¾è®¡åŽŸåˆ™
- **å•ä¸€èŒè´£**: æ¯ä¸ªæ¨¡å—åªè´Ÿè´£ä¸€ä¸ªç‰¹å®šåŠŸèƒ½
- **æ¾è€¦åˆ**: æ¨¡å—é—´é€šè¿‡ä¿¡å·æ§½é€šä¿¡ï¼Œå‡å°‘ç›´æŽ¥ä¾èµ–
- **é«˜å†…èš**: ç›¸å…³åŠŸèƒ½é›†ä¸­åœ¨åŒä¸€æ¨¡å—å†…
- **å¯æ‰©å±•**: é¢„ç•™æŽ¥å£ï¼Œä¾¿äºŽæ·»åŠ æ–°åŠŸèƒ½

### æŠ€æœ¯æ ˆ
- **GUIæ¡†æž¶**: PyQt5
- **å›¾å½¢ç³»ç»Ÿ**: QGraphicsView/QGraphicsScene
- **äº‹ä»¶æœºåˆ¶**: ä¿¡å·æ§½ (Signal/Slot)
- **æ•°æ®åºåˆ—åŒ–**: JSON
- **æ¨¡å—ç®¡ç†**: PythonåŒ…ç»“æž„

## ðŸ”§ æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 1. main_window.py - ä¸»çª—å£æ¨¡å—

#### æ ¸å¿ƒç±»: MLVisualizationUI
```python
class MLVisualizationUI(QMainWindow):
    """ä¸»çª—å£ç±»ï¼Œè´Ÿè´£æ•´ä½“ç•Œé¢å¸ƒå±€å’Œèœå•ç®¡ç†"""

    def __init__(self):
        # åˆå§‹åŒ–UIç»„ä»¶
        # åˆ›å»ºèœå•æ ã€å·¥å…·æ ã€çŠ¶æ€æ 
        # è®¾ç½®ä¸‰é¢æ¿å¸ƒå±€

    def create_menu_bar(self):
        # æ–‡ä»¶èœå•: æ–°å»ºã€æ‰“å¼€ã€ä¿å­˜ã€é€€å‡º
        # ç¼–è¾‘èœå•: æ’¤é”€ã€é‡åšã€å¤åˆ¶ã€ç²˜è´´
        # è§†å›¾èœå•: ç¼©æ”¾ã€é€‚åº”çª—å£
        # è¿è¡Œèœå•: æ‰§è¡Œæµç¨‹ã€åœæ­¢æ‰§è¡Œ

    def connect_signals(self):
        # è¿žæŽ¥å„æ¨¡å—é—´çš„ä¿¡å·æ§½
```

#### ä¸»è¦èŒè´£
- **ç•Œé¢å¸ƒå±€**: ç®¡ç†ä¸‰é¢æ¿å¸ƒå±€å’Œåˆ†å‰²å™¨
- **èœå•ç®¡ç†**: åˆ›å»ºå’Œå¤„ç†èœå•æ ã€å·¥å…·æ 
- **æ–‡ä»¶æ“ä½œ**: é¡¹ç›®çš„æ–°å»ºã€æ‰“å¼€ã€ä¿å­˜
- **äº‹ä»¶åè°ƒ**: åè°ƒå„æ¨¡å—é—´çš„äº¤äº’

#### å…³é”®æ–¹æ³•
```python
# æ–‡ä»¶æ“ä½œ
def new_project(self)          # æ–°å»ºé¡¹ç›®
def open_project(self)         # æ‰“å¼€é¡¹ç›®
def save_project(self)         # ä¿å­˜é¡¹ç›®
def _save_to_file(self, path)  # ä¿å­˜åˆ°æŒ‡å®šæ–‡ä»¶

# äº‹ä»¶å¤„ç†
def on_component_selected(self, component)  # ç»„ä»¶é€‰æ‹©äº‹ä»¶
def on_component_added(self, component)     # ç»„ä»¶æ·»åŠ äº‹ä»¶
def on_connection_created(self, connection) # è¿žæŽ¥åˆ›å»ºäº‹ä»¶
```

### 2. canvas.py - ç”»å¸ƒæ¨¡å—

#### æ ¸å¿ƒç±»: MLCanvas
```python
class MLCanvas(QGraphicsView):
    """ç”»å¸ƒç±»ï¼Œç»§æ‰¿è‡ªQGraphicsViewï¼Œè´Ÿè´£ç»„ä»¶çš„æ˜¾ç¤ºå’Œäº¤äº’"""

    # ä¿¡å·å®šä¹‰
    component_selected = pyqtSignal(object)
    component_added = pyqtSignal(object)
    connection_created = pyqtSignal(object)
```

#### ä¸»è¦èŒè´£
- **ç»„ä»¶ç®¡ç†**: æ·»åŠ ã€åˆ é™¤ã€ç§»åŠ¨ç»„ä»¶
- **è¿žæŽ¥ç®¡ç†**: åˆ›å»ºã€åˆ é™¤ç»„ä»¶é—´çš„è¿žæŽ¥
- **äº¤äº’å¤„ç†**: æ‹–æ‹½ã€é€‰æ‹©ã€ç¼©æ”¾ç­‰ç”¨æˆ·æ“ä½œ
- **æ•°æ®ç®¡ç†**: å·¥ä½œæµç¨‹æ•°æ®çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–

#### å…³é”®æ–¹æ³•
```python
# æ‹–æ‹½å¤„ç†
def dragEnterEvent(self, event)   # æ‹–æ‹½è¿›å…¥
def dropEvent(self, event)        # æ‹–æ‹½æ”¾ä¸‹

# é¼ æ ‡äº‹ä»¶
def mousePressEvent(self, event)   # é¼ æ ‡æŒ‰ä¸‹
def mouseMoveEvent(self, event)    # é¼ æ ‡ç§»åŠ¨
def mouseReleaseEvent(self, event) # é¼ æ ‡é‡Šæ”¾

# è¿žæŽ¥ç®¡ç†
def start_connection(self, port)   # å¼€å§‹è¿žæŽ¥
def finish_connection(self, port)  # å®Œæˆè¿žæŽ¥
def cancel_connection(self)        # å–æ¶ˆè¿žæŽ¥

# æ•°æ®ç®¡ç†
def get_workflow_data(self)        # èŽ·å–å·¥ä½œæµç¨‹æ•°æ®
def load_workflow_data(self, data) # åŠ è½½å·¥ä½œæµç¨‹æ•°æ®
```

### 3. components.py - ç»„ä»¶æ¨¡å—

#### æ ¸å¿ƒç±»ç»“æž„
```python
# è¿žæŽ¥ç«¯å£
class ConnectionPort(QGraphicsEllipseItem):
    def __init__(self, parent_component, port_type, index, is_input=True)
    def update_position(self)  # æ›´æ–°ç«¯å£ä½ç½®

# è¿žæŽ¥çº¿
class ConnectionLine(QGraphicsLineItem):
    def __init__(self, start_port, end_port=None)
    def update_line(self)      # æ›´æ–°è¿žæŽ¥çº¿
    def set_temp_end_pos(self, pos)  # è®¾ç½®ä¸´æ—¶ç»“æŸä½ç½®

# MLç»„ä»¶åŸºç±»
class MLComponent(QGraphicsRectItem):
    def __init__(self, component_type, name, width=120, height=80)
    def setup_appearance(self)  # è®¾ç½®å¤–è§‚
    def create_ports(self)      # åˆ›å»ºç«¯å£
    def get_properties(self)    # èŽ·å–å±žæ€§
    def set_properties(self, properties)  # è®¾ç½®å±žæ€§
```

#### ç»„ä»¶ç±»åž‹å’Œç«¯å£é…ç½®
```python
port_config = {
    'data': {'inputs': 0, 'outputs': 1},        # æ•°æ®ç»„ä»¶
    'preprocess': {'inputs': 1, 'outputs': 1},  # é¢„å¤„ç†ç»„ä»¶
    'model': {'inputs': 1, 'outputs': 1},       # æ¨¡åž‹ç»„ä»¶
    'evaluate': {'inputs': 2, 'outputs': 1},    # è¯„ä¼°ç»„ä»¶
    'output': {'inputs': 1, 'outputs': 0}       # è¾“å‡ºç»„ä»¶
}
```

### 4. component_library.py - ç»„ä»¶åº“æ¨¡å—

#### æ ¸å¿ƒç±»: ComponentLibrary
```python
class ComponentLibrary(QWidget):
    """ç»„ä»¶åº“é¢æ¿ï¼Œç®¡ç†æ‰€æœ‰å¯ç”¨çš„MLç»„ä»¶"""

    def __init__(self):
        self.component_types = self._init_component_types()
        self.init_ui()
```

#### ç»„ä»¶åˆ†ç±»ç»“æž„
```python
ç»„ä»¶åº“
â”œâ”€â”€ æ•°æ®å¤„ç†
â”‚   â”œâ”€â”€ æ•°æ®åŠ è½½
â”‚   â”œâ”€â”€ æ•°æ®æ¸…æ´—
â”‚   â”œâ”€â”€ ç‰¹å¾é€‰æ‹©
â”‚   â””â”€â”€ æ•°æ®åˆ†å‰²
â”œâ”€â”€ é¢„å¤„ç†
â”‚   â”œâ”€â”€ æ ‡å‡†åŒ–
â”‚   â”œâ”€â”€ å½’ä¸€åŒ–
â”‚   â”œâ”€â”€ ç¼–ç 
â”‚   â””â”€â”€ é™ç»´
â”œâ”€â”€ æœºå™¨å­¦ä¹ æ¨¡åž‹
â”‚   â”œâ”€â”€ çº¿æ€§å›žå½’
â”‚   â”œâ”€â”€ å†³ç­–æ ‘
â”‚   â”œâ”€â”€ éšæœºæ£®æž—
â”‚   â”œâ”€â”€ SVM
â”‚   â””â”€â”€ ç¥žç»ç½‘ç»œ
â”œâ”€â”€ æ¨¡åž‹è¯„ä¼°
â”‚   â”œâ”€â”€ å‡†ç¡®çŽ‡
â”‚   â”œâ”€â”€ æ··æ·†çŸ©é˜µ
â”‚   â”œâ”€â”€ ROCæ›²çº¿
â”‚   â””â”€â”€ ç‰¹å¾é‡è¦æ€§
â””â”€â”€ è¾“å‡º
    â”œâ”€â”€ ç»“æžœä¿å­˜
    â”œâ”€â”€ å¯è§†åŒ–
    â””â”€â”€ æŠ¥å‘Šç”Ÿæˆ
```

#### å…³é”®æ–¹æ³•
```python
def create_draggable_item(self, name)     # åˆ›å»ºå¯æ‹–æ‹½é¡¹
def start_drag(self, item)                # å¼€å§‹æ‹–æ‹½
def get_component_info(self, name)        # èŽ·å–ç»„ä»¶ä¿¡æ¯
def add_custom_component(self, ...)       # æ·»åŠ è‡ªå®šä¹‰ç»„ä»¶
```

### 5. property_panel.py - å±žæ€§é¢æ¿æ¨¡å—

#### æ ¸å¿ƒç±»: PropertyPanel
```python
class PropertyPanel(QWidget):
    """å±žæ€§é…ç½®é¢æ¿ï¼ŒåŠ¨æ€æ˜¾ç¤ºå’Œé…ç½®ç»„ä»¶å±žæ€§"""

    # ä¿¡å·å®šä¹‰
    property_changed = pyqtSignal(object, str, object)

    def __init__(self):
        self.current_component = None
        self.property_widgets = {}  # å­˜å‚¨å±žæ€§æŽ§ä»¶
```

#### å±žæ€§æŽ§ä»¶ç±»åž‹
```python
æŽ§ä»¶ç±»åž‹æ˜ å°„:
- "LineEdit"      â†’ QLineEdit      # æ–‡æœ¬è¾“å…¥
- "ComboBox"      â†’ QComboBox      # ä¸‹æ‹‰é€‰æ‹©
- "SpinBox"       â†’ QSpinBox       # æ•´æ•°è¾“å…¥
- "DoubleSpinBox" â†’ QDoubleSpinBox # æµ®ç‚¹æ•°è¾“å…¥
- "CheckBox"      â†’ QCheckBox      # å¤é€‰æ¡†
```

#### ç»„ä»¶å±žæ€§é…ç½®ç¤ºä¾‹
```python
# æ•°æ®åŠ è½½ç»„ä»¶å±žæ€§
data_loader_properties = [
    ("æ–‡ä»¶è·¯å¾„", "LineEdit", "data.csv"),
    ("åˆ†éš”ç¬¦", "ComboBox", [",", ";", "\t"]),
    ("ç¼–ç æ ¼å¼", "ComboBox", ["utf-8", "gbk", "ascii"])
]

# éšæœºæ£®æž—æ¨¡åž‹å±žæ€§
random_forest_properties = [
    ("æ ‘çš„æ•°é‡", "SpinBox", 100),
    ("æœ€å¤§æ·±åº¦", "SpinBox", 10),
    ("æœ€å°åˆ†å‰²æ ·æœ¬", "SpinBox", 2),
    ("éšæœºçŠ¶æ€", "SpinBox", 42)
]
```

#### å…³é”®æ–¹æ³•
```python
def show_component_properties(self, component)  # æ˜¾ç¤ºç»„ä»¶å±žæ€§
def add_property_group(self, title, properties) # æ·»åŠ å±žæ€§ç»„
def _create_property_widget(self, type, value)  # åˆ›å»ºå±žæ€§æŽ§ä»¶
def get_component_properties(self)              # èŽ·å–æ‰€æœ‰å±žæ€§å€¼
def set_component_properties(self, properties) # è®¾ç½®å±žæ€§å€¼
```

### 6. utils.py - å·¥å…·æ¨¡å—

#### æ ¸å¿ƒç±»ç»“æž„
```python
# ç»„ä»¶é…ç½®æ•°æ®ç±»
@dataclass
class ComponentConfig:
    component_id: str
    component_type: str
    name: str
    position: tuple
    properties: dict

# è¿žæŽ¥é…ç½®æ•°æ®ç±»
@dataclass
class ConnectionConfig:
    start_component: str
    start_port: int
    end_component: str
    end_port: int

# å·¥ä½œæµç¨‹ç®¡ç†å™¨
class WorkflowManager:
    def add_component(self, config)     # æ·»åŠ ç»„ä»¶
    def add_connection(self, config)    # æ·»åŠ è¿žæŽ¥
    def get_execution_order(self)       # èŽ·å–æ‰§è¡Œé¡ºåº(æ‹“æ‰‘æŽ’åº)
    def validate_workflow(self)         # éªŒè¯å·¥ä½œæµç¨‹
    def export_to_dict(self)            # å¯¼å‡ºæ•°æ®
    def import_from_dict(self, data)    # å¯¼å…¥æ•°æ®

# æ‰§è¡Œå¼•æ“Ž(é¢„ç•™æŽ¥å£)
class ExecutionEngine:
    def execute_workflow(self, workflow_manager)  # æ‰§è¡Œå·¥ä½œæµç¨‹
    def _execute_component(self, component)       # æ‰§è¡Œå•ä¸ªç»„ä»¶
```

## ðŸ”„ æ•°æ®æµå’Œäº‹ä»¶æœºåˆ¶

### ä¿¡å·æ§½æœºåˆ¶
```python
# ä¸»è¦ä¿¡å·æµå‘
ComponentLibrary â†’ MLCanvas â†’ PropertyPanel â†’ MLVisualizationUI
      â†“              â†“             â†“              â†“
   æ‹–æ‹½ç»„ä»¶        æ·»åŠ ç»„ä»¶      å±žæ€§é…ç½®        çŠ¶æ€æ›´æ–°
```

### äº‹ä»¶å¤„ç†æµç¨‹
```python
1. ç”¨æˆ·æ“ä½œ (æ‹–æ‹½ã€ç‚¹å‡»ã€è¾“å…¥)
   â†“
2. Qtäº‹ä»¶ç³»ç»Ÿæ•èŽ·
   â†“
3. å¯¹åº”çš„äº‹ä»¶å¤„ç†å‡½æ•°
   â†“
4. å‘å°„è‡ªå®šä¹‰ä¿¡å·
   â†“
5. è¿žæŽ¥çš„æ§½å‡½æ•°å¤„ç†
   â†“
6. æ›´æ–°æ•°æ®æ¨¡åž‹
   â†“
7. åˆ·æ–°ç•Œé¢æ˜¾ç¤º
```

### å…³é”®ä¿¡å·è¿žæŽ¥
```python
# åœ¨main_window.pyä¸­çš„connect_signals()æ–¹æ³•
self.canvas.component_selected.connect(self.on_component_selected)
self.canvas.component_added.connect(self.on_component_added)
self.canvas.connection_created.connect(self.on_connection_created)
self.property_panel.property_changed.connect(self.on_property_changed)
```

## ðŸ“Š æ•°æ®æ¨¡åž‹

### é¡¹ç›®æ–‡ä»¶æ ¼å¼(.mlv)
```json
{
  "components": [
    {
      "id": "component_id",
      "type": "data",
      "name": "æ•°æ®åŠ è½½",
      "position": [100, 100],
      "properties": {
        "file_path": "data.csv",
        "separator": ",",
        "encoding": "utf-8"
      }
    }
  ],
  "connections": [
    {
      "start_component": "comp1_id",
      "start_port": 0,
      "end_component": "comp2_id",
      "end_port": 0
    }
  ]
}
```

### å†…å­˜æ•°æ®ç»“æž„
```python
# ç”»å¸ƒä¸­çš„æ•°æ®ç»“æž„
canvas.components = [MLComponent, ...]      # ç»„ä»¶åˆ—è¡¨
canvas.connections = [ConnectionLine, ...]  # è¿žæŽ¥åˆ—è¡¨

# ç»„ä»¶çš„æ•°æ®ç»“æž„
component.component_type = "data"           # ç»„ä»¶ç±»åž‹
component.name = "æ•°æ®åŠ è½½"                 # ç»„ä»¶åç§°
component.input_ports = [Port, ...]        # è¾“å…¥ç«¯å£
component.output_ports = [Port, ...]       # è¾“å‡ºç«¯å£
component.properties = {...}               # ç»„ä»¶å±žæ€§
```

## ðŸš€ æ‰©å±•å¼€å‘æŒ‡å—

### æ·»åŠ æ–°çš„ç»„ä»¶ç±»åž‹

#### 1. åœ¨ç»„ä»¶åº“ä¸­æ³¨å†Œæ–°ç»„ä»¶
```python
# åœ¨ ml_visual/component_library.py ä¸­
def _init_component_types(self):
    return {
        # çŽ°æœ‰ç»„ä»¶...
        "æ–°ç»„ä»¶åç§°": "new_type",  # æ·»åŠ æ–°ç»„ä»¶
    }

def _create_component_categories(self):
    # åœ¨é€‚å½“çš„åˆ†ç±»ä¸‹æ·»åŠ 
    category_item.addChild(self.create_draggable_item("æ–°ç»„ä»¶åç§°"))
```

#### 2. é…ç½®ç»„ä»¶ç«¯å£
```python
# åœ¨ ml_visual/components.py ä¸­
def create_ports(self):
    port_config = {
        # çŽ°æœ‰é…ç½®...
        'new_type': {'inputs': 2, 'outputs': 1},  # æ–°ç»„ä»¶ç«¯å£é…ç½®
    }
```

#### 3. æ·»åŠ å±žæ€§é…ç½®
```python
# åœ¨ ml_visual/property_panel.py ä¸­
def show_component_properties(self, component):
    # çŽ°æœ‰ä»£ç ...
    elif component.component_type == 'new_type':
        self.add_new_type_properties(component)

def add_new_type_properties(self, component):
    """æ·»åŠ æ–°ç»„ä»¶ç±»åž‹çš„å±žæ€§"""
    self.add_property_group("æ–°ç»„ä»¶å‚æ•°", [
        ("å‚æ•°1", "LineEdit", "é»˜è®¤å€¼"),
        ("å‚æ•°2", "SpinBox", 100),
        ("å‚æ•°3", "ComboBox", ["é€‰é¡¹1", "é€‰é¡¹2"])
    ])
```

#### 4. å®žçŽ°æ‰§è¡Œé€»è¾‘
```python
# åœ¨ ml_visual/utils.py ä¸­
def _execute_component(self, component):
    if component.component_type == 'new_type':
        return self._execute_new_type_component(component)
    # çŽ°æœ‰ä»£ç ...

def _execute_new_type_component(self, component):
    """æ‰§è¡Œæ–°ç»„ä»¶ç±»åž‹"""
    print(f"æ‰§è¡Œæ–°ç»„ä»¶: {component.name}")
    # å®žçŽ°å…·ä½“çš„æ‰§è¡Œé€»è¾‘
    return True
```

### è‡ªå®šä¹‰ç»„ä»¶å¤–è§‚

#### ä¿®æ”¹ç»„ä»¶é¢œè‰²
```python
# åœ¨ ml_visual/components.py ä¸­
def setup_appearance(self):
    colors = {
        # çŽ°æœ‰é¢œè‰²...
        'new_type': QColor(255, 100, 200),  # æ–°ç»„ä»¶é¢œè‰²
    }
```

#### è‡ªå®šä¹‰ç»„ä»¶å½¢çŠ¶
```python
class CustomMLComponent(MLComponent):
    """è‡ªå®šä¹‰å½¢çŠ¶çš„MLç»„ä»¶"""

    def __init__(self, component_type, name):
        super().__init__(component_type, name)
        # è‡ªå®šä¹‰åˆå§‹åŒ–

    def paint(self, painter, option, widget):
        """è‡ªå®šä¹‰ç»˜åˆ¶æ–¹æ³•"""
        # ç»˜åˆ¶è‡ªå®šä¹‰å½¢çŠ¶
        painter.setBrush(self.brush())
        painter.setPen(self.pen())
        # ç»˜åˆ¶åœ†è§’çŸ©å½¢ã€æ¤­åœ†ç­‰
        painter.drawRoundedRect(self.rect(), 10, 10)
```

### æ·»åŠ æ–°çš„å±žæ€§æŽ§ä»¶ç±»åž‹

#### 1. æ‰©å±•æŽ§ä»¶ç±»åž‹
```python
# åœ¨ ml_visual/property_panel.py ä¸­
def _create_property_widget(self, prop_type, default_value):
    if prop_type == "FileDialog":
        widget = QPushButton("é€‰æ‹©æ–‡ä»¶")
        widget.clicked.connect(lambda: self._open_file_dialog(widget))
        return widget
    elif prop_type == "ColorPicker":
        widget = QPushButton()
        widget.setStyleSheet(f"background-color: {default_value}")
        widget.clicked.connect(lambda: self._open_color_dialog(widget))
        return widget
    # çŽ°æœ‰ä»£ç ...

def _open_file_dialog(self, button):
    """æ‰“å¼€æ–‡ä»¶å¯¹è¯æ¡†"""
    file_path, _ = QFileDialog.getOpenFileName(self, "é€‰æ‹©æ–‡ä»¶")
    if file_path:
        button.setText(os.path.basename(file_path))
        button.file_path = file_path

def _open_color_dialog(self, button):
    """æ‰“å¼€é¢œè‰²å¯¹è¯æ¡†"""
    color = QColorDialog.getColor()
    if color.isValid():
        button.setStyleSheet(f"background-color: {color.name()}")
        button.color = color.name()
```

### æ·»åŠ æ–°çš„èœå•åŠŸèƒ½

#### 1. åœ¨ä¸»çª—å£æ·»åŠ èœå•é¡¹
```python
# åœ¨ ml_visual/main_window.py ä¸­
def create_menu_bar(self):
    # çŽ°æœ‰èœå•...

    # æ·»åŠ å·¥å…·èœå•
    tools_menu = menubar.addMenu('å·¥å…·(&T)')

    validate_action = tools_menu.addAction('éªŒè¯å·¥ä½œæµç¨‹(&V)')
    validate_action.triggered.connect(self.validate_workflow)

    export_action = tools_menu.addAction('å¯¼å‡ºä¸ºå›¾ç‰‡(&E)')
    export_action.triggered.connect(self.export_as_image)

def validate_workflow(self):
    """éªŒè¯å·¥ä½œæµç¨‹"""
    workflow_data = self.canvas.get_workflow_data()
    from ml_visual.utils import WorkflowManager

    wm = WorkflowManager()
    wm.import_from_dict(workflow_data)
    errors = wm.validate_workflow()

    if errors:
        QMessageBox.warning(self, "éªŒè¯å¤±è´¥", "\n".join(errors))
    else:
        QMessageBox.information(self, "éªŒè¯æˆåŠŸ", "å·¥ä½œæµç¨‹éªŒè¯é€šè¿‡ï¼")

def export_as_image(self):
    """å¯¼å‡ºç”»å¸ƒä¸ºå›¾ç‰‡"""
    file_path, _ = QFileDialog.getSaveFileName(
        self, "å¯¼å‡ºå›¾ç‰‡", "", "PNGæ–‡ä»¶ (*.png);;JPGæ–‡ä»¶ (*.jpg)"
    )
    if file_path:
        # èŽ·å–åœºæ™¯çš„è¾¹ç•ŒçŸ©å½¢
        rect = self.canvas.scene.itemsBoundingRect()
        # åˆ›å»ºå›¾ç‰‡
        pixmap = QPixmap(rect.size().toSize())
        pixmap.fill(Qt.white)
        # æ¸²æŸ“åœºæ™¯åˆ°å›¾ç‰‡
        painter = QPainter(pixmap)
        self.canvas.scene.render(painter, QRectF(), rect)
        painter.end()
        # ä¿å­˜å›¾ç‰‡
        pixmap.save(file_path)
        self.statusBar().showMessage(f"å›¾ç‰‡å·²ä¿å­˜: {file_path}")
```

## ðŸ”Œ åŽç«¯é›†æˆæŒ‡å—

### é›†æˆScikit-learn

#### 1. åˆ›å»ºMLæ‰§è¡Œå™¨
```python
# åˆ›å»º ml_visual/ml_backends/sklearn_backend.py
import pandas as pd
from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestClassifier
from sklearn.preprocessing import StandardScaler
from sklearn.metrics import accuracy_score

class SklearnExecutor:
    """Scikit-learnåŽç«¯æ‰§è¡Œå™¨"""

    def __init__(self):
        self.data_cache = {}  # ç¼“å­˜ä¸­é—´æ•°æ®

    def execute_data_loader(self, component_config):
        """æ‰§è¡Œæ•°æ®åŠ è½½ç»„ä»¶"""
        file_path = component_config.properties.get('file_path', '')
        separator = component_config.properties.get('separator', ',')
        encoding = component_config.properties.get('encoding', 'utf-8')

        try:
            data = pd.read_csv(file_path, sep=separator, encoding=encoding)
            self.data_cache[component_config.component_id] = data
            return True, f"æˆåŠŸåŠ è½½æ•°æ®: {data.shape}"
        except Exception as e:
            return False, f"æ•°æ®åŠ è½½å¤±è´¥: {str(e)}"

    def execute_random_forest(self, component_config, input_data):
        """æ‰§è¡Œéšæœºæ£®æž—ç»„ä»¶"""
        n_estimators = component_config.properties.get('n_estimators', 100)
        max_depth = component_config.properties.get('max_depth', None)
        random_state = component_config.properties.get('random_state', 42)

        try:
            X, y = input_data  # å‡è®¾è¾“å…¥æ•°æ®æ˜¯ç‰¹å¾å’Œæ ‡ç­¾
            model = RandomForestClassifier(
                n_estimators=n_estimators,
                max_depth=max_depth,
                random_state=random_state
            )
            model.fit(X, y)
            self.data_cache[component_config.component_id] = model
            return True, f"æ¨¡åž‹è®­ç»ƒå®Œæˆï¼Œç‰¹å¾æ•°: {X.shape[1]}"
        except Exception as e:
            return False, f"æ¨¡åž‹è®­ç»ƒå¤±è´¥: {str(e)}"
```

#### 2. é›†æˆåˆ°æ‰§è¡Œå¼•æ“Ž
```python
# åœ¨ ml_visual/utils.py ä¸­ä¿®æ”¹ExecutionEngine
class ExecutionEngine:
    def __init__(self):
        self.is_running = False
        self.sklearn_executor = None

    def set_backend(self, backend_type="sklearn"):
        """è®¾ç½®åŽç«¯ç±»åž‹"""
        if backend_type == "sklearn":
            from ml_visual.ml_backends.sklearn_backend import SklearnExecutor
            self.sklearn_executor = SklearnExecutor()

    def _execute_component(self, component):
        """æ‰§è¡Œå•ä¸ªç»„ä»¶"""
        if self.sklearn_executor:
            return self._execute_with_sklearn(component)
        else:
            return self._execute_mock(component)  # æ¨¡æ‹Ÿæ‰§è¡Œ

    def _execute_with_sklearn(self, component):
        """ä½¿ç”¨sklearnæ‰§è¡Œç»„ä»¶"""
        if component.component_type == 'data' and 'åŠ è½½' in component.name:
            success, message = self.sklearn_executor.execute_data_loader(component)
            print(f"  {message}")
            return success
        elif component.component_type == 'model' and 'éšæœºæ£®æž—' in component.name:
            # èŽ·å–è¾“å…¥æ•°æ®
            input_data = self._get_component_input_data(component)
            success, message = self.sklearn_executor.execute_random_forest(component, input_data)
            print(f"  {message}")
            return success
        # å…¶ä»–ç»„ä»¶ç±»åž‹...
        return True
```

### é›†æˆTensorFlow/Keras

#### 1. åˆ›å»ºæ·±åº¦å­¦ä¹ æ‰§è¡Œå™¨
```python
# åˆ›å»º ml_visual/ml_backends/tensorflow_backend.py
import tensorflow as tf
from tensorflow import keras

class TensorFlowExecutor:
    """TensorFlowåŽç«¯æ‰§è¡Œå™¨"""

    def __init__(self):
        self.models = {}
        self.data_cache = {}

    def execute_neural_network(self, component_config, input_data):
        """æ‰§è¡Œç¥žç»ç½‘ç»œç»„ä»¶"""
        hidden_layers = component_config.properties.get('hidden_layers', '100,50')
        activation = component_config.properties.get('activation', 'relu')
        learning_rate = component_config.properties.get('learning_rate', 0.001)
        epochs = component_config.properties.get('epochs', 100)

        try:
            X, y = input_data

            # è§£æžéšè—å±‚é…ç½®
            layer_sizes = [int(x.strip()) for x in hidden_layers.split(',')]

            # æž„å»ºæ¨¡åž‹
            model = keras.Sequential()
            model.add(keras.layers.Dense(layer_sizes[0], activation=activation, input_shape=(X.shape[1],)))

            for size in layer_sizes[1:]:
                model.add(keras.layers.Dense(size, activation=activation))

            # è¾“å‡ºå±‚
            n_classes = len(set(y))
            if n_classes == 2:
                model.add(keras.layers.Dense(1, activation='sigmoid'))
                model.compile(optimizer=keras.optimizers.Adam(learning_rate=learning_rate),
                            loss='binary_crossentropy', metrics=['accuracy'])
            else:
                model.add(keras.layers.Dense(n_classes, activation='softmax'))
                model.compile(optimizer=keras.optimizers.Adam(learning_rate=learning_rate),
                            loss='sparse_categorical_crossentropy', metrics=['accuracy'])

            # è®­ç»ƒæ¨¡åž‹
            history = model.fit(X, y, epochs=epochs, verbose=0, validation_split=0.2)

            self.models[component_config.component_id] = model
            final_accuracy = history.history['val_accuracy'][-1]

            return True, f"ç¥žç»ç½‘ç»œè®­ç»ƒå®Œæˆï¼ŒéªŒè¯å‡†ç¡®çŽ‡: {final_accuracy:.4f}"

        except Exception as e:
            return False, f"ç¥žç»ç½‘ç»œè®­ç»ƒå¤±è´¥: {str(e)}"
```

### æ•°æ®æµç®¡ç†

#### 1. å®žçŽ°æ•°æ®ä¼ é€’æœºåˆ¶
```python
# åœ¨ ml_visual/utils.py ä¸­æ·»åŠ æ•°æ®ç®¡ç†
class DataFlowManager:
    """æ•°æ®æµç®¡ç†å™¨"""

    def __init__(self):
        self.data_cache = {}  # ç»„ä»¶è¾“å‡ºæ•°æ®ç¼“å­˜

    def set_component_output(self, component_id, port_index, data):
        """è®¾ç½®ç»„ä»¶è¾“å‡ºæ•°æ®"""
        key = f"{component_id}_{port_index}"
        self.data_cache[key] = data

    def get_component_input(self, component_id, port_index, connections):
        """èŽ·å–ç»„ä»¶è¾“å…¥æ•°æ®"""
        # æŸ¥æ‰¾è¿žæŽ¥åˆ°æ­¤è¾“å…¥ç«¯å£çš„è¾“å‡ºç«¯å£
        for conn in connections:
            if (conn.end_component == component_id and
                conn.end_port == port_index):

                output_key = f"{conn.start_component}_{conn.start_port}"
                return self.data_cache.get(output_key)
        return None

    def clear_cache(self):
        """æ¸…ç©ºæ•°æ®ç¼“å­˜"""
        self.data_cache.clear()
```

#### 2. ä¿®æ”¹æ‰§è¡Œå¼•æ“Žæ”¯æŒæ•°æ®æµ
```python
class ExecutionEngine:
    def __init__(self):
        self.is_running = False
        self.data_flow_manager = DataFlowManager()
        self.sklearn_executor = None

    def execute_workflow(self, workflow_manager):
        """æ‰§è¡Œå·¥ä½œæµç¨‹"""
        # æ¸…ç©ºæ•°æ®ç¼“å­˜
        self.data_flow_manager.clear_cache()

        # èŽ·å–æ‰§è¡Œé¡ºåº
        execution_order = workflow_manager.get_execution_order()

        for component_id in execution_order:
            component = workflow_manager.components[component_id]

            # èŽ·å–è¾“å…¥æ•°æ®
            input_data = self._get_component_inputs(component_id, workflow_manager.connections)

            # æ‰§è¡Œç»„ä»¶
            success, output_data = self._execute_component_with_data(component, input_data)

            if not success:
                return False

            # ç¼“å­˜è¾“å‡ºæ•°æ®
            if output_data is not None:
                self.data_flow_manager.set_component_output(component_id, 0, output_data)

        return True

    def _get_component_inputs(self, component_id, connections):
        """èŽ·å–ç»„ä»¶çš„æ‰€æœ‰è¾“å…¥æ•°æ®"""
        inputs = []
        component = self.workflow_manager.components[component_id]

        for i in range(len(component.input_ports)):
            input_data = self.data_flow_manager.get_component_input(
                component_id, i, connections
            )
            inputs.append(input_data)

        return inputs
```

## ðŸ› è°ƒè¯•å’Œæµ‹è¯•

### è°ƒè¯•æŠ€å·§

#### 1. å¯ç”¨è¯¦ç»†æ—¥å¿—
```python
# åœ¨ä¸»ç¨‹åºå¼€å§‹å¤„æ·»åŠ 
import logging

logging.basicConfig(
    level=logging.DEBUG,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('ml_visual_debug.log'),
        logging.StreamHandler()
    ]
)

logger = logging.getLogger(__name__)
```

#### 2. ç»„ä»¶çŠ¶æ€å¯è§†åŒ–
```python
# åœ¨ ml_visual/components.py ä¸­æ·»åŠ çŠ¶æ€æ˜¾ç¤º
class MLComponent(QGraphicsRectItem):
    def __init__(self, component_type, name, width=120, height=80):
        super().__init__(0, 0, width, height)
        # çŽ°æœ‰ä»£ç ...
        self.status = "ready"  # ready, running, completed, error
        self.status_indicator = QGraphicsEllipseItem(width-15, 5, 10, 10, self)
        self.update_status_indicator()

    def set_status(self, status):
        """è®¾ç½®ç»„ä»¶çŠ¶æ€"""
        self.status = status
        self.update_status_indicator()

    def update_status_indicator(self):
        """æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨"""
        colors = {
            "ready": QColor(128, 128, 128),      # ç°è‰²
            "running": QColor(255, 165, 0),     # æ©™è‰²
            "completed": QColor(0, 255, 0),     # ç»¿è‰²
            "error": QColor(255, 0, 0)          # çº¢è‰²
        }
        color = colors.get(self.status, QColor(128, 128, 128))
        self.status_indicator.setBrush(QBrush(color))
```

#### 3. è¿žæŽ¥éªŒè¯
```python
# åœ¨ ml_visual/canvas.py ä¸­æ·»åŠ è¿žæŽ¥éªŒè¯
def finish_connection(self, end_port):
    """å®Œæˆè¿žæŽ¥"""
    if not self._validate_connection(self.current_connection.start_port, end_port):
        self.cancel_connection()
        QMessageBox.warning(self, "è¿žæŽ¥é”™è¯¯", "ä¸å…¼å®¹çš„ç«¯å£ç±»åž‹")
        return

    # çŽ°æœ‰è¿žæŽ¥é€»è¾‘...

def _validate_connection(self, start_port, end_port):
    """éªŒè¯è¿žæŽ¥æ˜¯å¦æœ‰æ•ˆ"""
    # æ£€æŸ¥ç«¯å£ç±»åž‹å…¼å®¹æ€§
    start_type = start_port.port_type
    end_type = end_port.port_type

    # å®šä¹‰å…¼å®¹æ€§è§„åˆ™
    compatibility_rules = {
        "data": ["data", "model_input"],
        "model_output": ["evaluation_input"],
        # æ·»åŠ æ›´å¤šè§„åˆ™...
    }

    return end_type in compatibility_rules.get(start_type, [end_type])
```

### å•å…ƒæµ‹è¯•

#### 1. æµ‹è¯•ç»„ä»¶åˆ›å»º
```python
# åˆ›å»º tests/test_components.py
import unittest
import sys
import os
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from ml_visual.components import MLComponent, ConnectionPort

class TestMLComponent(unittest.TestCase):

    def test_component_creation(self):
        """æµ‹è¯•ç»„ä»¶åˆ›å»º"""
        component = MLComponent("data", "æµ‹è¯•ç»„ä»¶")

        self.assertEqual(component.component_type, "data")
        self.assertEqual(component.name, "æµ‹è¯•ç»„ä»¶")
        self.assertIsNotNone(component.input_ports)
        self.assertIsNotNone(component.output_ports)

    def test_port_creation(self):
        """æµ‹è¯•ç«¯å£åˆ›å»º"""
        component = MLComponent("preprocess", "é¢„å¤„ç†ç»„ä»¶")

        # é¢„å¤„ç†ç»„ä»¶åº”è¯¥æœ‰1ä¸ªè¾“å…¥ç«¯å£å’Œ1ä¸ªè¾“å‡ºç«¯å£
        self.assertEqual(len(component.input_ports), 1)
        self.assertEqual(len(component.output_ports), 1)

    def test_component_properties(self):
        """æµ‹è¯•ç»„ä»¶å±žæ€§"""
        component = MLComponent("model", "éšæœºæ£®æž—")
        properties = component.get_properties()

        self.assertIn('type', properties)
        self.assertIn('name', properties)
        self.assertIn('position', properties)

if __name__ == '__main__':
    unittest.main()
```

#### 2. æµ‹è¯•å·¥ä½œæµç¨‹ç®¡ç†
```python
# åˆ›å»º tests/test_workflow.py
import unittest
from ml_visual.utils import WorkflowManager, ComponentConfig, ConnectionConfig

class TestWorkflowManager(unittest.TestCase):

    def setUp(self):
        """æµ‹è¯•å‰å‡†å¤‡"""
        self.wm = WorkflowManager()

    def test_add_component(self):
        """æµ‹è¯•æ·»åŠ ç»„ä»¶"""
        config = ComponentConfig(
            component_id="test_1",
            component_type="data",
            name="æµ‹è¯•ç»„ä»¶",
            position=(100, 100),
            properties={}
        )

        self.wm.add_component(config)
        self.assertIn("test_1", self.wm.components)

    def test_execution_order(self):
        """æµ‹è¯•æ‰§è¡Œé¡ºåºè®¡ç®—"""
        # æ·»åŠ ç»„ä»¶
        comp1 = ComponentConfig("comp1", "data", "æ•°æ®åŠ è½½", (0, 0), {})
        comp2 = ComponentConfig("comp2", "model", "æ¨¡åž‹", (100, 0), {})

        self.wm.add_component(comp1)
        self.wm.add_component(comp2)

        # æ·»åŠ è¿žæŽ¥
        conn = ConnectionConfig("comp1", 0, "comp2", 0)
        self.wm.add_connection(conn)

        # æµ‹è¯•æ‰§è¡Œé¡ºåº
        order = self.wm.get_execution_order()
        self.assertEqual(order, ["comp1", "comp2"])

    def test_cycle_detection(self):
        """æµ‹è¯•å¾ªçŽ¯ä¾èµ–æ£€æµ‹"""
        # åˆ›å»ºå¾ªçŽ¯ä¾èµ–
        comp1 = ComponentConfig("comp1", "data", "ç»„ä»¶1", (0, 0), {})
        comp2 = ComponentConfig("comp2", "model", "ç»„ä»¶2", (100, 0), {})

        self.wm.add_component(comp1)
        self.wm.add_component(comp2)

        # åˆ›å»ºå¾ªçŽ¯è¿žæŽ¥
        self.wm.add_connection(ConnectionConfig("comp1", 0, "comp2", 0))
        self.wm.add_connection(ConnectionConfig("comp2", 0, "comp1", 0))

        # åº”è¯¥æ£€æµ‹åˆ°å¾ªçŽ¯ä¾èµ–
        with self.assertRaises(ValueError):
            self.wm.get_execution_order()

if __name__ == '__main__':
    unittest.main()
```

### æ€§èƒ½æµ‹è¯•

#### 1. å¤§é‡ç»„ä»¶æ€§èƒ½æµ‹è¯•
```python
# åˆ›å»º tests/test_performance.py
import time
import unittest
from PyQt5.QtWidgets import QApplication
from PyQt5.QtCore import QPointF

from ml_visual import MLVisualizationUI

class TestPerformance(unittest.TestCase):

    @classmethod
    def setUpClass(cls):
        """æµ‹è¯•ç±»åˆå§‹åŒ–"""
        cls.app = QApplication([])
        cls.window = MLVisualizationUI()

    def test_large_workflow_creation(self):
        """æµ‹è¯•å¤§åž‹å·¥ä½œæµç¨‹åˆ›å»ºæ€§èƒ½"""
        start_time = time.time()

        # åˆ›å»º100ä¸ªç»„ä»¶
        for i in range(100):
            self.window.canvas.add_component(
                'data', f'ç»„ä»¶_{i}', QPointF(i * 150, (i % 10) * 100)
            )

        creation_time = time.time() - start_time
        print(f"åˆ›å»º100ä¸ªç»„ä»¶è€—æ—¶: {creation_time:.2f}ç§’")

        # æ€§èƒ½è¦æ±‚ï¼šåˆ›å»º100ä¸ªç»„ä»¶åº”åœ¨1ç§’å†…å®Œæˆ
        self.assertLess(creation_time, 1.0)

    def test_canvas_rendering_performance(self):
        """æµ‹è¯•ç”»å¸ƒæ¸²æŸ“æ€§èƒ½"""
        # æ·»åŠ å¤§é‡ç»„ä»¶åŽæµ‹è¯•æ¸²æŸ“æ€§èƒ½
        start_time = time.time()

        # å¼ºåˆ¶é‡ç»˜
        self.window.canvas.viewport().update()
        self.app.processEvents()

        render_time = time.time() - start_time
        print(f"ç”»å¸ƒæ¸²æŸ“è€—æ—¶: {render_time:.3f}ç§’")

        # æ¸²æŸ“æ—¶é—´åº”è¯¥å¾ˆçŸ­
        self.assertLess(render_time, 0.1)

if __name__ == '__main__':
    unittest.main()
```

## âš¡ æ€§èƒ½ä¼˜åŒ–

### ç•Œé¢æ€§èƒ½ä¼˜åŒ–

#### 1. ç”»å¸ƒä¼˜åŒ–
```python
# åœ¨ ml_visual/canvas.py ä¸­ä¼˜åŒ–æ¸²æŸ“
class MLCanvas(QGraphicsView):
    def __init__(self):
        super().__init__()
        # å¯ç”¨ç¼“å­˜æ¨¡å¼
        self.setCacheMode(QGraphicsView.CacheBackground)

        # ä¼˜åŒ–æ¸²æŸ“æç¤º
        self.setRenderHints(
            QPainter.Antialiasing |
            QPainter.TextAntialiasing |
            QPainter.SmoothPixmapTransform
        )

        # è®¾ç½®ä¼˜åŒ–æ ‡å¿—
        self.setOptimizationFlags(
            QGraphicsView.DontSavePainterState |
            QGraphicsView.DontAdjustForAntialiasing
        )

        # å¯ç”¨OpenGLæ¸²æŸ“ï¼ˆå¦‚æžœå¯ç”¨ï¼‰
        try:
            from PyQt5.QtOpenGL import QOpenGLWidget
            self.setViewport(QOpenGLWidget())
        except ImportError:
            pass  # OpenGLä¸å¯ç”¨æ—¶ä½¿ç”¨é»˜è®¤æ¸²æŸ“
```

#### 2. ç»„ä»¶å»¶è¿ŸåŠ è½½
```python
# å®žçŽ°ç»„ä»¶çš„å»¶è¿Ÿåˆ›å»º
class LazyMLComponent(MLComponent):
    """å»¶è¿ŸåŠ è½½çš„MLç»„ä»¶"""

    def __init__(self, component_type, name):
        super().__init__(component_type, name)
        self._ports_created = False

    def create_ports(self):
        """å»¶è¿Ÿåˆ›å»ºç«¯å£"""
        if not self._ports_created:
            super().create_ports()
            self._ports_created = True

    def paint(self, painter, option, widget):
        """åªåœ¨å¯è§æ—¶åˆ›å»ºç«¯å£"""
        if not self._ports_created:
            self.create_ports()
        super().paint(painter, option, widget)
```

#### 3. å†…å­˜ç®¡ç†
```python
# åœ¨ç»„ä»¶åˆ é™¤æ—¶æ¸…ç†èµ„æº
class MLCanvas(QGraphicsView):
    def remove_component(self, component):
        """ç§»é™¤ç»„ä»¶å¹¶æ¸…ç†èµ„æº"""
        if component in self.components:
            # æ¸…ç†ç«¯å£è¿žæŽ¥
            for port in component.input_ports + component.output_ports:
                for connection in port.connections[:]:  # å¤åˆ¶åˆ—è¡¨é¿å…ä¿®æ”¹æ—¶è¿­ä»£
                    self.remove_connection(connection)

            # æ¸…ç†å›¾å½¢é¡¹
            for port in component.input_ports + component.output_ports:
                if port.scene():
                    self.scene.removeItem(port)

            # æ¸…ç†æ–‡æœ¬é¡¹
            if component.text_item and component.text_item.scene():
                self.scene.removeItem(component.text_item)

            # ä»Žåœºæ™¯å’Œåˆ—è¡¨ä¸­ç§»é™¤
            self.scene.removeItem(component)
            self.components.remove(component)

            # å¼ºåˆ¶åžƒåœ¾å›žæ”¶
            import gc
            gc.collect()
```

### æ•°æ®å¤„ç†ä¼˜åŒ–

#### 1. æ•°æ®ç¼“å­˜ç­–ç•¥
```python
# åœ¨ ml_visual/utils.py ä¸­å®žçŽ°æ™ºèƒ½ç¼“å­˜
class SmartDataCache:
    """æ™ºèƒ½æ•°æ®ç¼“å­˜"""

    def __init__(self, max_memory_mb=500):
        self.cache = {}
        self.access_times = {}
        self.max_memory = max_memory_mb * 1024 * 1024  # è½¬æ¢ä¸ºå­—èŠ‚
        self.current_memory = 0

    def set(self, key, data):
        """è®¾ç½®ç¼“å­˜æ•°æ®"""
        import sys
        data_size = sys.getsizeof(data)

        # æ£€æŸ¥å†…å­˜é™åˆ¶
        if self.current_memory + data_size > self.max_memory:
            self._evict_lru()

        self.cache[key] = data
        self.access_times[key] = time.time()
        self.current_memory += data_size

    def get(self, key):
        """èŽ·å–ç¼“å­˜æ•°æ®"""
        if key in self.cache:
            self.access_times[key] = time.time()
            return self.cache[key]
        return None

    def _evict_lru(self):
        """æ¸…ç†æœ€å°‘ä½¿ç”¨çš„æ•°æ®"""
        if not self.cache:
            return

        # æ‰¾åˆ°æœ€å°‘ä½¿ç”¨çš„é”®
        lru_key = min(self.access_times.keys(), key=lambda k: self.access_times[k])

        # ç§»é™¤æ•°æ®
        data = self.cache.pop(lru_key)
        del self.access_times[lru_key]

        import sys
        self.current_memory -= sys.getsizeof(data)
```

#### 2. å¼‚æ­¥æ‰§è¡Œ
```python
# å®žçŽ°å¼‚æ­¥ç»„ä»¶æ‰§è¡Œ
from PyQt5.QtCore import QThread, pyqtSignal

class AsyncExecutionThread(QThread):
    """å¼‚æ­¥æ‰§è¡Œçº¿ç¨‹"""

    component_started = pyqtSignal(str)      # ç»„ä»¶å¼€å§‹æ‰§è¡Œ
    component_finished = pyqtSignal(str, bool, str)  # ç»„ä»¶æ‰§è¡Œå®Œæˆ
    workflow_finished = pyqtSignal(bool)     # å·¥ä½œæµç¨‹æ‰§è¡Œå®Œæˆ

    def __init__(self, workflow_manager, execution_engine):
        super().__init__()
        self.workflow_manager = workflow_manager
        self.execution_engine = execution_engine
        self.should_stop = False

    def run(self):
        """åœ¨åŽå°çº¿ç¨‹ä¸­æ‰§è¡Œå·¥ä½œæµç¨‹"""
        try:
            execution_order = self.workflow_manager.get_execution_order()

            for component_id in execution_order:
                if self.should_stop:
                    break

                component = self.workflow_manager.components[component_id]
                self.component_started.emit(component_id)

                # æ‰§è¡Œç»„ä»¶
                success = self.execution_engine._execute_component(component)

                self.component_finished.emit(
                    component_id, success,
                    "æ‰§è¡ŒæˆåŠŸ" if success else "æ‰§è¡Œå¤±è´¥"
                )

                if not success:
                    self.workflow_finished.emit(False)
                    return

            self.workflow_finished.emit(True)

        except Exception as e:
            self.workflow_finished.emit(False)

    def stop(self):
        """åœæ­¢æ‰§è¡Œ"""
        self.should_stop = True
```

## â“ å¸¸è§é—®é¢˜è§£ç­”

### Q1: å¦‚ä½•æ·»åŠ è‡ªå®šä¹‰çš„æœºå™¨å­¦ä¹ ç®—æ³•ï¼Ÿ

**A:** æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤ï¼š

1. åœ¨`component_library.py`ä¸­æ³¨å†Œæ–°ç®—æ³•
2. åœ¨`components.py`ä¸­é…ç½®ç«¯å£
3. åœ¨`property_panel.py`ä¸­æ·»åŠ å‚æ•°é…ç½®
4. åœ¨`utils.py`æˆ–åŽç«¯æ¨¡å—ä¸­å®žçŽ°æ‰§è¡Œé€»è¾‘

```python
# ç¤ºä¾‹ï¼šæ·»åŠ K-Meansèšç±»ç®—æ³•
# 1. æ³¨å†Œç»„ä»¶
self.component_types["K-Meansèšç±»"] = "clustering"

# 2. é…ç½®ç«¯å£
port_config = {
    'clustering': {'inputs': 1, 'outputs': 1}
}

# 3. æ·»åŠ å±žæ€§
def add_clustering_properties(self, component):
    if "K-Means" in component.name:
        self.add_property_group("èšç±»å‚æ•°", [
            ("èšç±»æ•°é‡", "SpinBox", 3),
            ("æœ€å¤§è¿­ä»£æ¬¡æ•°", "SpinBox", 300),
            ("éšæœºçŠ¶æ€", "SpinBox", 42)
        ])

# 4. å®žçŽ°æ‰§è¡Œé€»è¾‘
def _execute_clustering_component(self, component):
    from sklearn.cluster import KMeans
    n_clusters = component.properties.get('n_clusters', 3)
    # å®žçŽ°èšç±»é€»è¾‘...
```

### Q2: å¦‚ä½•å®žçŽ°ç»„ä»¶çš„æ’¤é”€/é‡åšåŠŸèƒ½ï¼Ÿ

**A:** å®žçŽ°å‘½ä»¤æ¨¡å¼ï¼š

```python
# åˆ›å»ºå‘½ä»¤åŸºç±»
class Command:
    def execute(self):
        raise NotImplementedError

    def undo(self):
        raise NotImplementedError

# æ·»åŠ ç»„ä»¶å‘½ä»¤
class AddComponentCommand(Command):
    def __init__(self, canvas, component_type, name, position):
        self.canvas = canvas
        self.component_type = component_type
        self.name = name
        self.position = position
        self.component = None

    def execute(self):
        self.component = self.canvas.add_component(
            self.component_type, self.name, self.position
        )

    def undo(self):
        if self.component:
            self.canvas.remove_component(self.component)

# å‘½ä»¤ç®¡ç†å™¨
class CommandManager:
    def __init__(self):
        self.history = []
        self.current_index = -1

    def execute_command(self, command):
        command.execute()
        # æ¸…é™¤é‡åšåŽ†å²
        self.history = self.history[:self.current_index + 1]
        self.history.append(command)
        self.current_index += 1

    def undo(self):
        if self.current_index >= 0:
            command = self.history[self.current_index]
            command.undo()
            self.current_index -= 1

    def redo(self):
        if self.current_index < len(self.history) - 1:
            self.current_index += 1
            command = self.history[self.current_index]
            command.execute()
```

### Q3: å¦‚ä½•ä¼˜åŒ–å¤§åž‹å·¥ä½œæµç¨‹çš„æ€§èƒ½ï¼Ÿ

**A:** é‡‡ç”¨ä»¥ä¸‹ä¼˜åŒ–ç­–ç•¥ï¼š

1. **è§†å£è£å‰ª**: åªæ¸²æŸ“å¯è§åŒºåŸŸçš„ç»„ä»¶
2. **çº§åˆ«ç»†èŠ‚**: æ ¹æ®ç¼©æ”¾çº§åˆ«æ˜¾ç¤ºä¸åŒè¯¦ç»†ç¨‹åº¦
3. **æ‰¹é‡æ“ä½œ**: æ‰¹é‡å¤„ç†å¤šä¸ªç»„ä»¶çš„æ“ä½œ
4. **å¼‚æ­¥åŠ è½½**: å¤§åž‹æ•°æ®é›†çš„å¼‚æ­¥åŠ è½½

```python
# è§†å£è£å‰ªç¤ºä¾‹
def paintEvent(self, event):
    """åªç»˜åˆ¶å¯è§åŒºåŸŸ"""
    visible_rect = self.mapToScene(self.viewport().rect()).boundingRect()

    for component in self.components:
        if component.boundingRect().intersects(visible_rect):
            # åªç»˜åˆ¶å¯è§ç»„ä»¶
            component.setVisible(True)
        else:
            component.setVisible(False)

    super().paintEvent(event)
```

### Q4: å¦‚ä½•å®žçŽ°ç»„ä»¶é—´çš„æ•°æ®ç±»åž‹æ£€æŸ¥ï¼Ÿ

**A:** å®žçŽ°ç±»åž‹ç³»ç»Ÿï¼š

```python
# å®šä¹‰æ•°æ®ç±»åž‹
class DataType:
    def __init__(self, name, compatible_types=None):
        self.name = name
        self.compatible_types = compatible_types or []

    def is_compatible_with(self, other_type):
        return (other_type.name == self.name or
                other_type.name in self.compatible_types)

# é¢„å®šä¹‰æ•°æ®ç±»åž‹
DATA_TYPES = {
    'dataframe': DataType('dataframe', ['array', 'matrix']),
    'array': DataType('array', ['matrix']),
    'model': DataType('model'),
    'metrics': DataType('metrics')
}

# åœ¨ç«¯å£ä¸­ä½¿ç”¨ç±»åž‹
class ConnectionPort(QGraphicsEllipseItem):
    def __init__(self, parent_component, data_type, index, is_input=True):
        super().__init__(-5, -5, 10, 10)
        self.data_type = DATA_TYPES.get(data_type, DATA_TYPES['dataframe'])
        # å…¶ä»–åˆå§‹åŒ–ä»£ç ...

# è¿žæŽ¥éªŒè¯
def _validate_connection(self, start_port, end_port):
    return start_port.data_type.is_compatible_with(end_port.data_type)
```

### Q5: å¦‚ä½•å®žçŽ°æ’ä»¶ç³»ç»Ÿï¼Ÿ

**A:** åˆ›å»ºæ’ä»¶æž¶æž„ï¼š

```python
# æ’ä»¶åŸºç±»
class MLVisualPlugin:
    """æ’ä»¶åŸºç±»"""

    def __init__(self):
        self.name = ""
        self.version = "1.0.0"
        self.description = ""

    def initialize(self, main_window):
        """æ’ä»¶åˆå§‹åŒ–"""
        pass

    def get_components(self):
        """è¿”å›žæ’ä»¶æä¾›çš„ç»„ä»¶"""
        return []

    def get_menu_actions(self):
        """è¿”å›žæ’ä»¶çš„èœå•é¡¹"""
        return []

# æ’ä»¶ç®¡ç†å™¨
class PluginManager:
    def __init__(self):
        self.plugins = []

    def load_plugins(self, plugin_dir):
        """ä»Žç›®å½•åŠ è½½æ’ä»¶"""
        import importlib.util
        import os

        for filename in os.listdir(plugin_dir):
            if filename.endswith('.py'):
                plugin_path = os.path.join(plugin_dir, filename)
                spec = importlib.util.spec_from_file_location(
                    filename[:-3], plugin_path
                )
                module = importlib.util.module_from_spec(spec)
                spec.loader.exec_module(module)

                # æŸ¥æ‰¾æ’ä»¶ç±»
                for attr_name in dir(module):
                    attr = getattr(module, attr_name)
                    if (isinstance(attr, type) and
                        issubclass(attr, MLVisualPlugin) and
                        attr != MLVisualPlugin):
                        plugin = attr()
                        self.plugins.append(plugin)

    def initialize_plugins(self, main_window):
        """åˆå§‹åŒ–æ‰€æœ‰æ’ä»¶"""
        for plugin in self.plugins:
            plugin.initialize(main_window)
```

## ðŸ“š å‚è€ƒèµ„æº

### å®˜æ–¹æ–‡æ¡£
- [PyQt5 å®˜æ–¹æ–‡æ¡£](https://doc.qt.io/qtforpython/)
- [Qt Graphics View Framework](https://doc.qt.io/qt-5/graphicsview.html)

### ç›¸å…³åº“æ–‡æ¡£
- [Scikit-learn](https://scikit-learn.org/stable/)
- [TensorFlow](https://www.tensorflow.org/)
- [Pandas](https://pandas.pydata.org/)
- [NumPy](https://numpy.org/)

### è®¾è®¡æ¨¡å¼å‚è€ƒ
- ã€Šè®¾è®¡æ¨¡å¼ï¼šå¯å¤ç”¨é¢å‘å¯¹è±¡è½¯ä»¶çš„åŸºç¡€ã€‹
- ã€ŠPyQt5å¿«é€Ÿå¼€å‘ä¸Žå®žæˆ˜ã€‹

---

è¿™ä»½å¼€å‘è€…æŒ‡å—æ¶µç›–äº†é¡¹ç›®çš„æ ¸å¿ƒæž¶æž„ã€æ‰©å±•æ–¹æ³•ã€åŽç«¯é›†æˆã€è°ƒè¯•æµ‹è¯•å’Œæ€§èƒ½ä¼˜åŒ–ç­‰æ–¹é¢ã€‚é€šè¿‡è¿™ä»½æŒ‡å—ï¼Œä½ å¯ä»¥æ·±å…¥ç†è§£é¡¹ç›®ç»“æž„ï¼Œå¹¶èƒ½å¤Ÿæœ‰æ•ˆåœ°æ‰©å±•å’Œç»´æŠ¤è¿™ä¸ªæœºå™¨å­¦ä¹ å¯è§†åŒ–ç•Œé¢ã€‚